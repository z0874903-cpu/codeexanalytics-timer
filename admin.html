<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeExAnalytics | Admin Portal</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Elegant Admin Design */
        :root {
            --primary: #1e40af;
            --primary-dark: #1e3a8a;
            --primary-light: #dbeafe;
            --secondary: #047857;
            --accent: #7c3aed;
            --dark: #0f172a;
            --light: #f8fafc;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
        }
        
        .stat-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            border: 1px solid rgba(229, 231, 235, 0.5);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(30, 64, 175, 0.3);
        }
        
        .sidebar {
            background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
            color: white;
            height: 100vh;
            width: 64px;
            transition: all 0.3s ease;
            overflow-y: auto;
            position: fixed;
            left: 0;
            top: 0;
            z-index: 40;
        }
        
        .sidebar.expanded {
            width: 256px;
        }
        
        .sidebar-item {
            transition: all 0.2s ease;
            border-radius: 10px;
            white-space: nowrap;
            overflow: hidden;
        }
        
        .sidebar-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }
        
        .sidebar-item.active {
            background: rgba(30, 64, 175, 0.2);
            border-left: 4px solid var(--primary);
        }
        
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: white;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
        }
        
        .badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .badge-primary {
            background: var(--primary-light);
            color: var(--primary-dark);
        }
        
        .badge-success {
            background: #d1fae5;
            color: var(--secondary);
        }
        
        .badge-warning {
            background: #fef3c7;
            color: #d97706;
        }
        
        .badge-danger {
            background: #fee2e2;
            color: #dc2626;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background: white;
            margin: 5% auto;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
            animation: modalSlide 0.3s ease;
            max-width: 800px;
        }
        
        @keyframes modalSlide {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--dark);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            animation: toastSlide 0.3s ease;
            z-index: 1001;
        }
        
        @keyframes toastSlide {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .table-row {
            transition: all 0.2s ease;
        }
        
        .table-row:hover {
            background: #f8fafc;
            transform: scale(1.002);
        }
        
        .input-field {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            transition: all 0.2s ease;
        }
        
        .input-field:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
        }
        
        .select-field {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            transition: all 0.2s ease;
        }
        
        .select-field:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
        }
        
        .chart-container {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .mobile-menu-toggle {
            display: none;
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 50;
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: var(--primary);
            color: white;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            border: none;
            cursor: pointer;
        }

        /* ========== RESPONSIVE DESIGN ========== */
        /* Tablet and Mobile */
        @media (max-width: 1200px) {
            .main-content {
                margin-left: 0 !important;
                padding: 5rem 1rem 1rem 1rem !important;
            }
            
            .sidebar {
                width: 0;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                top: 0;
                height: 100vh;
                z-index: 40;
                position: fixed;
            }
            
            .sidebar.active {
                width: 256px;
                transform: translateX(0);
            }
            
            .mobile-menu-toggle {
                display: flex !important;
            }
            
            .modal-content {
                margin: 10% 1rem !important;
                width: calc(100% - 2rem) !important;
                max-height: calc(100vh - 2rem) !important;
                overflow-y: auto !important;
            }
            
            /* Adjust navigation text */
            nav h1.text-lg {
                font-size: 1rem !important;
                max-width: 150px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
            
            .hidden.md\:block {
                display: none !important;
            }
        }

        @media (max-width: 768px) {
            /* Navigation */
            nav .px-6 {
                padding-left: 4rem !important;
                padding-right: 1rem !important;
            }
            
            nav h1 {
                font-size: 1rem !important;
                max-width: 120px;
            }
            
            .mobile-menu-toggle {
                top: 0.75rem !important;
                left: 0.75rem !important;
                width: 44px !important;
                height: 44px !important;
            }
            
            /* Stats Grid */
            .grid.grid-cols-1.md\:grid-cols-2.lg\:grid-cols-4 {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 0.75rem !important;
            }
            
            .stat-card {
                padding: 1rem !important;
            }
            
            .stat-card p.text-3xl {
                font-size: 1.75rem !important;
            }
            
            /* Charts */
            .grid.grid-cols-1.lg\:grid-cols-2 {
                grid-template-columns: 1fr !important;
            }
            
            .chart-container,
            .stat-card.p-6 {
                padding: 1rem !important;
            }
            
            /* Tables */
            .overflow-x-auto {
                font-size: 0.875rem;
            }
            
            table th, table td {
                padding: 0.75rem 0.5rem !important;
            }
            
            /* Forms and filters */
            .grid.grid-cols-1.md\:grid-cols-4.gap-4,
            .grid.grid-cols-2.gap-4 {
                grid-template-columns: 1fr !important;
                gap: 0.75rem !important;
            }
            
            .stat-card.p-6.mb-6 .flex.items-center.space-x-4 {
                flex-direction: column !important;
                gap: 0.75rem !important;
            }
            
            .stat-card.p-6.mb-6 .flex.items-center.space-x-4 > * {
                width: 100% !important;
            }
            
            /* Employee table actions */
            .flex.space-x-2 {
                flex-wrap: wrap;
                gap: 0.25rem;
            }
            
            /* Login page */
            #adminLoginPage .max-w-md {
                max-width: 100% !important;
                padding: 1rem !important;
            }
            
            .glass-card.rounded-2xl.p-8 {
                padding: 1.5rem !important;
            }
            
            /* Modal content */
            .modal-content {
                margin: 5% 0.5rem !important;
                border-radius: 12px !important;
            }
            
            .modal-content .p-6 {
                padding: 1rem !important;
            }
            
            /* Hide some non-essential elements on mobile */
            .hidden.md\:block {
                display: none !important;
            }
            
            /* Text sizes */
            h1.text-3xl {
                font-size: 1.75rem !important;
            }
            
            h2.text-2xl {
                font-size: 1.5rem !important;
            }
            
            .text-lg {
                font-size: 1rem !important;
            }
            
            /* Buttons */
            .btn-primary, button[class*="py-3"] {
                padding-top: 0.75rem !important;
                padding-bottom: 0.75rem !important;
            }
            
            /* Toast */
            .toast {
                left: 0.5rem !important;
                right: 0.5rem !important;
                bottom: 0.5rem !important;
                width: calc(100% - 1rem) !important;
            }
            
            /* Sidebar text on mobile - Show when active */
            .sidebar.active span {
                display: inline !important;
            }
            
            .sidebar span {
                display: none;
            }
            
            /* Fix admin name in navigation on mobile */
            #adminMenuBtn .text-left {
                display: none;
            }
            
            /* Dashboard title adjustment */
            .mb-8 h1.text-3xl {
                font-size: 1.5rem !important;
                line-height: 1.2;
            }
            
            .mb-8 p.text-gray-600 {
                font-size: 0.875rem;
            }
        }

        @media (max-width: 480px) {
            /* Extra small devices */
            .grid.grid-cols-1.md\:grid-cols-2.lg\:grid-cols-4 {
                grid-template-columns: 1fr !important;
            }
            
            .stat-card {
                margin-bottom: 0.5rem;
            }
            
            /* Tables - make horizontal scroll more obvious */
            .overflow-x-auto {
                -webkit-overflow-scrolling: touch;
                overflow-x: auto;
                position: relative;
            }
            
            table {
                min-width: 600px; /* Force horizontal scroll on small screens */
            }
            
            /* Navigation adjustments */
            nav .flex.items-center.space-x-4 {
                gap: 0.5rem;
            }
            
            /* Stats icons */
            .w-12.h-12 {
                width: 2.5rem !important;
                height: 2.5rem !important;
            }
            
            /* Chart containers */
            .h-64 {
                height: 200px !important;
            }
            
            /* Login page logo */
            .w-16.h-16 {
                width: 3rem !important;
                height: 3rem !important;
            }
            
            .text-3xl {
                font-size: 1.5rem !important;
            }
            
            /* Button text */
            .btn-primary {
                font-size: 0.875rem;
            }
            
            /* Sidebar icons */
            .sidebar-item i {
                font-size: 1.125rem;
            }
            
            /* Fix dashboard header on very small screens */
            .mb-8 h1.text-3xl {
                font-size: 1.25rem !important;
            }
            
            /* Adjust padding for better mobile experience */
            .main-content {
                padding: 4.5rem 0.75rem 0.75rem 0.75rem !important;
            }
            
            /* Make mobile menu button more visible */
            .mobile-menu-toggle {
                top: 0.5rem !important;
                left: 0.5rem !important;
            }
        }

        /* Tablet-specific adjustments */
        @media (min-width: 769px) and (max-width: 1024px) {
            .main-content {
                margin-left: 0 !important;
                padding: 4rem 1.5rem 1.5rem 1.5rem !important;
            }
            
            .sidebar {
                width: 0;
            }
            
            .sidebar.active {
                width: 220px;
            }
            
            .mobile-menu-toggle {
                display: flex !important;
            }
            
            .grid.grid-cols-1.md\:grid-cols-2.lg\:grid-cols-4 {
                grid-template-columns: repeat(2, 1fr) !important;
            }
            
            .modal-content {
                margin: 5% 2rem !important;
                width: calc(100% - 4rem) !important;
            }
            
            /* Adjust navigation text for tablet */
            nav h1.text-lg {
                font-size: 1.1rem !important;
                max-width: 200px;
            }
        }

        /* Desktop specific adjustments */
        @media (min-width: 1201px) {
            .sidebar {
                width: 256px !important;
            }
            
            .main-content {
                margin-left: 256px !important;
            }
            
            .mobile-menu-toggle {
                display: none !important;
            }
            
            /* Show all sidebar text on desktop */
            .sidebar span {
                display: inline !important;
            }
            
            /* Fix dashboard spacing on desktop */
            nav h1.text-lg {
                font-size: 1.25rem !important;
                max-width: none;
            }
        }

        /* Large Desktop screens */
        @media (min-width: 1440px) {
            .main-content {
                padding-left: 2rem !important;
                padding-right: 2rem !important;
            }
            
            nav h1.text-lg {
                font-size: 1.5rem !important;
            }
        }

        /* Touch-friendly improvements for mobile */
        @media (hover: none) and (pointer: coarse) {
            /* Increase tap target sizes */
            button, 
            .sidebar-item,
            .table-row,
            input[type="button"],
            input[type="submit"] {
                min-height: 44px;
                min-width: 44px;
            }
            
            /* Prevent hover effects on touch devices */
            .stat-card:hover {
                transform: none;
            }
            
            .sidebar-item:hover {
                transform: none;
                background: none;
            }
            
            .sidebar-item.active:hover {
                background: rgba(30, 64, 175, 0.2);
            }
            
            /* Improve dropdown experience */
            #adminMenuBtn {
                padding: 0.5rem;
            }
            
            /* Better scroll experience */
            .sidebar {
                -webkit-overflow-scrolling: touch;
            }
        }

        /* Landscape mode adjustments */
        @media (max-height: 600px) and (orientation: landscape) {
            .sidebar {
                height: 100vh;
                overflow-y: auto;
            }
            
            .modal-content {
                max-height: 90vh;
                margin: 1% auto !important;
            }
            
            .main-content {
                padding-top: 4rem !important;
            }
            
            nav {
                height: 3.5rem;
            }
            
            .h-16 {
                height: 3.5rem;
            }
            
            /* Show more content in landscape */
            .h-64 {
                height: 150px !important;
            }
        }

        /* Print styles */
        @media print {
            .sidebar,
            .mobile-menu-toggle,
            nav,
            .modal,
            .toast,
            button {
                display: none !important;
            }
            
            .main-content {
                margin: 0 !important;
                padding: 0 !important;
                width: 100% !important;
            }
            
            .tab-content {
                display: block !important;
            }
            
            .stat-card {
                box-shadow: none !important;
                border: 1px solid #ddd !important;
                break-inside: avoid;
            }
            
            table {
                width: 100%;
                font-size: 12px;
            }
        }
        
        /* Ensure sidebar text is always visible when sidebar is expanded */
        .sidebar:not(.active) .sidebar-text {
            display: none !important;
        }
        
        .sidebar.active .sidebar-text {
            display: inline !important;
        }
        
        /* Dashboard tab content visibility */
        .tab-content {
            width: 100%;
        }
        
        /* Fix for dashboard header on mobile */
        .main-content > .tab-content {
            display: block;
        }
        
        #adminDashboard.tab-content {
            display: block;
        }
    </style>
</head>
<body class="text-gray-800">
    <!-- Admin Login Page -->
    <div id="adminLoginPage" class="min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-md">
            <div class="glass-card rounded-2xl p-8">
                <div class="text-center mb-8">
                    <div class="w-16 h-16 gradient-bg rounded-2xl flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-chart-line text-white text-2xl"></i>
                    </div>
                    <h1 class="text-3xl font-bold text-gray-900">CodeExAnalytics</h1>
                    <p class="text-gray-600 mt-2">Admin Portal</p>
                </div>
                
                <div class="mb-8">
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Admin Access</h2>
                    <p class="text-gray-600">Sign in to manage team and analytics</p>
                </div>
                
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
                        <input type="email" id="adminEmail" class="w-full px-4 py-3 input-field" 
                               placeholder="admin@codeexanalytics.com" value="admin@codeexanalytics.com">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                        <input type="password" id="adminPassword" class="w-full px-4 py-3 input-field" 
                               placeholder="••••••••" value="admin123">
                    </div>
                    
                    <button onclick="adminLogin()" class="w-full btn-primary py-3 rounded-xl font-medium text-lg">
                        Sign In as Admin
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="adminDashboard" class="hidden">
        <!-- Navigation -->
        <nav class="bg-white border-b border-gray-200 fixed w-full z-50 shadow-sm">
            <div class="px-6 h-16 flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 gradient-bg rounded-xl flex items-center justify-center">
                            <i class="fas fa-chart-line text-white"></i>
                        </div>
                        <div>
                            <h1 class="text-lg font-bold text-gray-900">CodeExAnalytics Admin</h1>
                        </div>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-right hidden md:block">
                        <p class="text-sm font-medium" id="currentDateTime"></p>
                        <p class="text-xs text-gray-500">Team Analytics Dashboard</p>
                    </div>
                    <div class="relative">
                        <button id="adminMenuBtn" class="flex items-center space-x-2 px-4 py-2 rounded-xl hover:bg-gray-50 transition-colors">
                            <div class="avatar">A</div>
                            <div class="text-left hidden sm:block">
                                <p class="text-sm font-medium" id="adminName">Admin User</p>
                                <p class="text-xs text-gray-500">Administrator</p>
                            </div>
                            <i class="fas fa-chevron-down text-gray-400 text-xs ml-2"></i>
                        </button>
                        <div id="adminDropdown" class="absolute right-0 mt-2 w-56 bg-white rounded-xl shadow-lg border border-gray-200 hidden z-20">
                            <div class="p-4 border-b border-gray-100">
                                <p class="text-sm font-medium" id="dropdownAdminName">Admin User</p>
                                <p class="text-xs text-gray-500" id="dropdownAdminEmail">admin@codeexanalytics.com</p>
                            </div>
                            <div class="p-2">
                                <button onclick="adminLogout()" class="w-full text-left px-3 py-3 text-sm text-red-600 hover:bg-red-50 rounded-lg transition-colors">
                                    <i class="fas fa-sign-out-alt mr-2"></i>Sign Out
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </nav>
        
        <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
            <i class="fas fa-bars"></i>
        </button>

        <!-- Sidebar -->
        <div class="sidebar fixed left-0 top-0 h-screen overflow-y-auto">
            <div class="p-4">
                <h2 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-4 sidebar-text">Control Panel</h2>
                <nav class="space-y-1">
                    <button onclick="switchTab('adminDashboard')" class="w-full flex items-center space-x-3 px-4 py-3 sidebar-item text-left" data-tab="adminDashboard">
                        <i class="fas fa-chart-pie w-5"></i>
                        <span class="sidebar-text">Dashboard</span>
                    </button>
                    <button onclick="switchTab('employees')" class="w-full flex items-center space-x-3 px-4 py-3 sidebar-item text-left" data-tab="employees">
                        <i class="fas fa-users w-5"></i>
                        <span class="sidebar-text">Employees</span>
                    </button>
                    <button onclick="switchTab('records')" class="w-full flex items-center space-x-3 px-4 py-3 sidebar-item text-left" data-tab="records">
                        <i class="fas fa-history w-5"></i>
                        <span class="sidebar-text">All Records</span>
                    </button>
                    <button onclick="switchTab('analytics')" class="w-full flex items-center space-x-3 px-4 py-3 sidebar-item text-left" data-tab="analytics">
                        <i class="fas fa-chart-bar w-5"></i>
                        <span class="sidebar-text">Analytics</span>
                    </button>
                </nav>
            </div>
            
            <div class="p-4 mt-6">
                <h2 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-4 sidebar-text">Quick Actions</h2>
                <div class="space-y-2">
                    <button onclick="showAddEmployeeModal()" class="w-full btn-primary py-2 rounded-lg text-sm font-medium">
                        <i class="fas fa-user-plus mr-2"></i>
                        <span class="sidebar-text">Add Employee</span>
                    </button>
                    <button onclick="exportAllData()" class="w-full bg-white text-gray-700 border border-gray-300 py-2 rounded-lg text-sm font-medium hover:bg-gray-50">
                        <i class="fas fa-file-export mr-2"></i>
                        <span class="sidebar-text">Export All Data</span>
                    </button>
                </div>
            </div>
            
            <div class="p-4 mt-6 border-t border-gray-700">
                <div class="text-xs text-gray-400 space-y-1">
                    <p><i class="fas fa-users mr-2"></i>
                        <span class="sidebar-text">Employees: </span>
                        <span id="totalEmployeesCount">0</span>
                    </p>
                    <p><i class="fas fa-history mr-2"></i>
                        <span class="sidebar-text">Records: </span>
                        <span id="totalRecordsCount">0</span>
                    </p>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content ml-64 pt-16 p-6 bg-gray-50 min-h-screen">
            <!-- Admin Dashboard Tab -->
            <div id="adminDashboardContent" class="tab-content">
                <div class="mb-8">
                    <h1 class="text-3xl font-bold text-gray-900">Admin Dashboard</h1>
                    <p class="text-gray-600">Team productivity and time tracking overview</p>
                </div>
                
                <!-- Stats Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="stat-card p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <p class="text-sm text-gray-500 font-medium">Today's Hours</p>
                                <p class="text-3xl font-bold text-gray-900 mt-2" id="totalHoursToday">0.0</p>
                            </div>
                            <div class="w-12 h-12 bg-blue-50 rounded-xl flex items-center justify-center">
                                <i class="fas fa-clock text-blue-500 text-xl"></i>
                            </div>
                        </div>
                        <div class="flex items-center text-sm text-gray-500">
                            <i class="fas fa-play-circle mr-2"></i>
                            <span id="activeTimersNow">0</span> active timers
                        </div>
                    </div>
                    
                    <div class="stat-card p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <p class="text-sm text-gray-500 font-medium">Weekly Total</p>
                                <p class="text-3xl font-bold text-gray-900 mt-2" id="weeklyTotal">0.0</p>
                            </div>
                            <div class="w-12 h-12 bg-green-50 rounded-xl flex items-center justify-center">
                                <i class="fas fa-calendar-alt text-green-500 text-xl"></i>
                            </div>
                        </div>
                        <div class="flex items-center text-sm text-gray-500">
                            <i class="fas fa-calendar-day mr-2"></i>
                            <span id="daysThisWeek">0</span> work days
                        </div>
                    </div>
                    
                    <div class="stat-card p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <p class="text-sm text-gray-500 font-medium">Team Members</p>
                                <p class="text-3xl font-bold text-gray-900 mt-2" id="totalTeamMembers">0</p>
                            </div>
                            <div class="w-12 h-12 bg-purple-50 rounded-xl flex items-center justify-center">
                                <i class="fas fa-users text-purple-500 text-xl"></i>
                            </div>
                        </div>
                        <div class="flex items-center text-sm text-gray-500">
                            <i class="fas fa-user-check mr-2"></i>
                            <span id="activeToday">0</span> active today
                        </div>
                    </div>
                    
                    <div class="stat-card p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <p class="text-sm text-gray-500 font-medium">Avg. Hours/Day</p>
                                <p class="text-3xl font-bold text-gray-900 mt-2" id="avgHoursPerDay">0.0</p>
                            </div>
                            <div class="w-12 h-12 bg-orange-50 rounded-xl flex items-center justify-center">
                                <i class="fas fa-chart-line text-orange-500 text-xl"></i>
                            </div>
                        </div>
                        <p class="text-sm text-gray-500">Team average this week</p>
                    </div>
                </div>
                
                <!-- Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="stat-card p-6">
                        <h3 class="text-lg font-semibold mb-4">Daily Hours Trend</h3>
                        <div class="h-64">
                            <canvas id="dailyTrendChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="stat-card p-6">
                        <h3 class="text-lg font-semibold mb-4">Department Distribution</h3>
                        <div class="h-64">
                            <canvas id="departmentChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Today's Activity -->
                <div class="stat-card">
                    <div class="p-6 border-b border-gray-100">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-semibold">Today's Activity</h3>
                            <button onclick="switchTab('records')" class="text-sm text-blue-600 hover:text-blue-800 font-medium flex items-center">
                                View all records <i class="fas fa-arrow-right ml-1"></i>
                            </button>
                        </div>
                    </div>
                    <div class="p-6">
                        <div id="dashboardActivity" class="space-y-4">
                            <!-- Activity will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Employees Tab -->
            <div id="employees" class="tab-content hidden">
                <div class="mb-8 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900">Team Management</h1>
                        <p class="text-gray-600">Manage employees and departments</p>
                    </div>
                    <button onclick="showAddEmployeeModal()" class="btn-primary px-6 py-3 rounded-xl font-medium w-full sm:w-auto">
                        <i class="fas fa-user-plus mr-2"></i>Add Employee
                    </button>
                </div>
                
                <!-- Search Bar -->
                <div class="stat-card p-6 mb-6">
                    <div class="flex flex-col sm:flex-row items-center space-y-3 sm:space-y-0 sm:space-x-4">
                        <div class="flex-1 w-full">
                            <div class="relative">
                                <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                <input type="text" id="employeeSearch" placeholder="Search employees by name, email, or department..." 
                                       class="w-full pl-10 pr-4 py-3 input-field">
                            </div>
                        </div>
                        <div class="flex space-x-2 w-full sm:w-auto">
                            <button onclick="filterEmployees()" class="btn-primary px-6 py-3 rounded-lg flex-1 sm:flex-none">
                                Search
                            </button>
                            <button onclick="resetEmployeeSearch()" class="border border-gray-300 px-6 py-3 rounded-lg hover:bg-gray-50 flex-1 sm:flex-none">
                                Reset
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Employees Table -->
                <div class="stat-card overflow-hidden">
                    <div class="p-6 border-b border-gray-100">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2">
                            <h3 class="text-lg font-semibold">All Employees</h3>
                            <span class="text-sm text-gray-500" id="employeeCount">0 employees</span>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="text-left py-4 px-6 text-sm font-medium text-gray-700">Employee</th>
                                    <th class="text-left py-4 px-6 text-sm font-medium text-gray-700">Department</th>
                                    <th class="text-left py-4 px-6 text-sm font-medium text-gray-700">Email</th>
                                    <th class="text-left py-4 px-6 text-sm font-medium text-gray-700">Hours This Week</th>
                                    <th class="text-left py-4 px-6 text-sm font-medium text-gray-700">Status</th>
                                    <th class="text-left py-4 px-6 text-sm font-medium text-gray-700">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="employeesTable" class="divide-y divide-gray-100"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Department Summary -->
                <div class="mt-8">
                    <div class="stat-card p-6">
                        <h4 class="text-lg font-semibold mb-4">Department Overview</h4>
                        <div id="departmentOverview">
                            <!-- Department stats will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- All Records Tab -->
            <div id="records" class="tab-content hidden">
                <div class="mb-8">
                    <h1 class="text-3xl font-bold text-gray-900">All Time Records</h1>
                    <p class="text-gray-600">Complete history of all tracked time</p>
                </div>
                
                <!-- Filters -->
                <div class="stat-card p-6 mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Date Range</label>
                            <select id="dateRangeFilter" class="w-full px-3 py-3 select-field">
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                                <option value="all">All Time</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Employee</label>
                            <select id="employeeFilter" class="w-full px-3 py-3 select-field">
                                <option value="all">All Employees</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Project</label>
                            <select id="projectFilter" class="w-full px-3 py-3 select-field">
                                <option value="all">All Projects</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Actions</label>
                            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                                <button onclick="filterRecords()" class="flex-1 btn-primary py-3 rounded-lg">Filter</button>
                                <button onclick="resetFilters()" class="flex-1 border border-gray-300 py-3 rounded-lg hover:bg-gray-50">Reset</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Records Table -->
                <div class="stat-card overflow-hidden">
                    <div class="p-6 border-b border-gray-100 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
                        <h3 class="text-lg font-semibold">Time Records</h3>
                        <div class="flex items-center space-x-3">
                            <span class="text-sm text-gray-500" id="recordsCount">0 records</span>
                            <button onclick="exportAllData()" class="text-sm text-blue-600 hover:text-blue-800 font-medium">
                                <i class="fas fa-download mr-1"></i>Export All
                            </button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="text-left py-4 px-6 text-sm font-medium text-gray-700">Date</th>
                                    <th class="text-left py-4 px-6 text-sm font-medium text-gray-700">Employee</th>
                                    <th class="text-left py-4 px-6 text-sm font-medium text-gray-700">Project</th>
                                    <th class="text-left py-4 px-6 text-sm font-medium text-gray-700">Task</th>
                                    <th class="text-left py-4 px-6 text-sm font-medium text-gray-700">Start Time</th>
                                    <th class="text-left py-4 px-6 text-sm font-medium text-gray-700">End Time</th>
                                    <th class="text-left py-4 px-6 text-sm font-medium text-gray-700">Duration</th>
                                </tr>
                            </thead>
                            <tbody id="allRecordsTable" class="divide-y divide-gray-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Analytics Tab -->
            <div id="analytics" class="tab-content hidden">
                <div class="mb-8">
                    <h1 class="text-3xl font-bold text-gray-900">Team Analytics</h1>
                    <p class="text-gray-600">Detailed insights and performance metrics</p>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="stat-card p-6">
                        <h3 class="text-lg font-semibold mb-4">Productivity Trends</h3>
                        <div class="h-64">
                            <canvas id="productivityChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="stat-card p-6">
                        <h3 class="text-lg font-semibold mb-4">Project Hours Distribution</h3>
                        <div class="h-64">
                            <canvas id="projectDistributionChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="stat-card p-6">
                    <h3 class="text-lg font-semibold mb-4">Team Performance Summary</h3>
                    <div id="performanceSummary" class="space-y-4">
                        <!-- Performance data will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Employee Modal -->
        <div id="addEmployeeModal" class="modal">
            <div class="modal-content">
                <div class="p-6 border-b border-gray-100">
                    <h3 class="text-lg font-semibold">Add New Employee</h3>
                </div>
                <div class="p-6">
                    <div class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">First Name</label>
                                <input type="text" id="firstName" class="w-full px-3 py-3 input-field">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Last Name</label>
                                <input type="text" id="lastName" class="w-full px-3 py-3 input-field">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
                            <input type="email" id="employeeEmail" class="w-full px-3 py-3 input-field">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                            <input type="password" id="employeePassword" class="w-full px-3 py-3 input-field" value="password123">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Department</label>
                            <select id="employeeDept" class="w-full px-3 py-3 select-field">
                                <option value="Development">Development</option>
                                <option value="Data Analytics">Data Analytics</option>
                                <option value="Quality Assurance">Quality Assurance</option>
                                <option value="Project Management">Project Management</option>
                                <option value="Sales">Sales</option>
                                <option value="Administration">Administration</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Position</label>
                            <input type="text" id="employeePosition" class="w-full px-3 py-3 input-field">
                        </div>
                    </div>
                </div>
                <div class="p-6 border-t border-gray-100 flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-3">
                    <button onclick="closeModal('addEmployeeModal')" class="px-5 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 w-full sm:w-auto">Cancel</button>
                    <button onclick="saveEmployee()" class="btn-primary px-5 py-2 rounded-lg w-full sm:w-auto">Save Employee</button>
                </div>
            </div>
        </div>

        <!-- Notification Toast -->
        <div id="toast" class="toast hidden"></div>
    </div>

    <script>
        // ==================== GLOBAL VARIABLES ====================
        let employees = JSON.parse(localStorage.getItem('ce_users')) || [];
        let timeRecords = JSON.parse(localStorage.getItem('ce_time_records')) || [];
        let currentAdmin = null;
        let dailyTrendChart = null;
        let departmentChart = null;
        let productivityChart = null;
        let projectDistributionChart = null;

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize default admin if none exists
            let employees = JSON.parse(localStorage.getItem('ce_users')) || [];
            let timeRecords = JSON.parse(localStorage.getItem('ce_time_records')) || [];
            
            // Check if admin account exists, if not create one
            if (employees.length === 0 || !employees.some(u => u.role === 'admin')) {
                const adminUser = {
                    id: 'admin_001',
                    firstName: 'Admin',
                    lastName: 'User',
                    email: 'admin@codeexanalytics.com',
                    password: 'admin123',
                    role: 'admin',
                    department: 'Administration',
                    position: 'System Administrator',
                    employeeId: 'ADM001',
                    createdAt: new Date().toISOString()
                };
                employees.push(adminUser);
                localStorage.setItem('ce_users', JSON.stringify(employees));
            }
            
            // Initialize empty time records if none
            if (timeRecords.length === 0) {
                localStorage.setItem('ce_time_records', JSON.stringify([]));
            }
            
            // Check if admin is already logged in
            const savedAdminId = sessionStorage.getItem('ce_current_admin');
            if (savedAdminId) {
                const adminId = JSON.parse(savedAdminId);
                currentAdmin = employees.find(u => u.id === adminId && u.role === 'admin');
                
                if (currentAdmin) {
                    document.getElementById('adminLoginPage').style.display = 'none';
                    document.getElementById('adminDashboard').style.display = 'block';
                    initializeAdminDashboard();
                }
            }
            
            // Set up event listeners
            setupEventListeners();
            
            // Initialize responsive sidebar on load
            initResponsiveSidebar();
        });

        function setupEventListeners() {
            // Admin menu toggle
            document.getElementById('adminMenuBtn').addEventListener('click', function(e) {
                e.stopPropagation();
                const dropdown = document.getElementById('adminDropdown');
                dropdown.classList.toggle('hidden');
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!document.getElementById('adminMenuBtn').contains(e.target)) {
                    document.getElementById('adminDropdown').classList.add('hidden');
                }
            });
        }

        function initResponsiveSidebar() {
            // On mobile, show sidebar text when sidebar is active
            const sidebar = document.querySelector('.sidebar');
            if (window.innerWidth <= 1200) {
                sidebar.classList.remove('expanded');
            } else {
                sidebar.classList.add('expanded');
            }
        }

        // ==================== AUTHENTICATION ====================
        function adminLogin() {
            const email = document.getElementById('adminEmail').value.trim().toLowerCase();
            const password = document.getElementById('adminPassword').value;
            
            if (!email || !password) {
                showToast('Please enter email and password', 'error');
                return;
            }
            
            const admin = employees.find(u => u.email.toLowerCase() === email && u.role === 'admin');
            
            if (!admin) {
                showToast('Admin account not found', 'error');
                return;
            }
            
            if (admin.password !== password) {
                showToast('Invalid password', 'error');
                return;
            }
            
            currentAdmin = admin;
            sessionStorage.setItem('ce_current_admin', JSON.stringify(admin.id));
            
            document.getElementById('adminLoginPage').style.display = 'none';
            document.getElementById('adminDashboard').style.display = 'block';
            
            showToast('Admin login successful!', 'success');
            initializeAdminDashboard();
        }

        function adminLogout() {
            currentAdmin = null;
            sessionStorage.removeItem('ce_current_admin');
            
            document.getElementById('adminDashboard').style.display = 'none';
            document.getElementById('adminLoginPage').style.display = 'flex';
            
            showToast('Signed out successfully', 'info');
        }

        // ==================== ADMIN DASHBOARD INITIALIZATION ====================
        function initializeAdminDashboard() {
            if (!currentAdmin) {
                adminLogout();
                return;
            }
            
            updateAdminInfo();
            updateDateTime();
            setInterval(updateDateTime, 60000);
            
            loadEmployeesTable();
            updateDashboardStats();
            loadEmployeeFilter();
            loadProjectFilter();
            updateCounts();
            initializeCharts();
            
            switchTab('adminDashboard');
            
            // Initialize responsive view
            handleResponsiveLayout();
        }

        function updateAdminInfo() {
            if (!currentAdmin) return;
            
            document.getElementById('adminName').textContent = `${currentAdmin.firstName} ${currentAdmin.lastName}`;
            document.getElementById('dropdownAdminName').textContent = `${currentAdmin.firstName} ${currentAdmin.lastName}`;
            document.getElementById('dropdownAdminEmail').textContent = currentAdmin.email;
        }

        function updateDateTime() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            document.getElementById('currentDateTime').textContent = now.toLocaleDateString('en-US', options);
        }

        function updateCounts() {
            const employeeCount = employees.filter(e => e.role === 'employee').length;
            const recordCount = timeRecords.filter(r => !r.isRunning).length;
            
            document.getElementById('totalEmployeesCount').textContent = employeeCount;
            document.getElementById('totalRecordsCount').textContent = recordCount;
        }

        // ==================== TAB NAVIGATION ====================
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active class from all sidebar items
            document.querySelectorAll('.sidebar-item').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show the selected tab content
            document.getElementById(tabName).classList.remove('hidden');
            
            // Add active class to clicked sidebar item
            const tabBtn = document.querySelector(`[data-tab="${tabName}"]`);
            if (tabBtn) {
                tabBtn.classList.add('active');
            }
            
            // Load specific content for each tab
            if (tabName === 'adminDashboardContent') {
                updateDashboardStats();
            } else if (tabName === 'records') {
                loadAllRecords();
            } else if (tabName === 'employees') {
                loadEmployeesTable();
                updateDepartmentOverview();
            } else if (tabName === 'analytics') {
                updateAnalytics();
            }
            
            // Close mobile menu after switching tabs on mobile
            if (window.innerWidth <= 1200) {
                toggleMobileMenu();
            }
        }

        // ==================== RESPONSIVE LAYOUT HANDLING ====================
        function handleResponsiveLayout() {
            if (window.innerWidth <= 1200) {
                const sidebar = document.querySelector('.sidebar');
                sidebar.classList.remove('expanded');
                
                // Ensure dashboard is visible
                document.getElementById('adminDashboardContent').classList.remove('hidden');
            } else {
                const sidebar = document.querySelector('.sidebar');
                sidebar.classList.add('expanded');
            }
        }

        // ==================== EMPLOYEE MANAGEMENT ====================
        function loadEmployeesTable() {
            const table = document.getElementById('employeesTable');
            const employeeList = employees.filter(e => e.role === 'employee' && e.id !== 'emp_001');
            
            table.innerHTML = '';
            
            if (employeeList.length === 0) {
                table.innerHTML = `
                    <tr>
                        <td colspan="6" class="py-12 text-center text-gray-500">
                            <div class="flex flex-col items-center">
                                <i class="fas fa-users text-5xl mb-4 text-gray-200"></i>
                                <p class="text-lg font-medium text-gray-700 mb-2">No employees yet</p>
                                <p class="text-sm text-gray-500 mb-4">Add your first employee to get started</p>
                                <button onclick="showAddEmployeeModal()" class="btn-primary px-6 py-3 rounded-lg font-medium">
                                    <i class="fas fa-user-plus mr-2"></i> Add First Employee
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                document.getElementById('employeeCount').textContent = '0 employees';
                return;
            }
                    
            employeeList.forEach(emp => {
                const hoursThisWeek = calculateEmployeeHoursThisWeek(emp.id);
                const row = document.createElement('tr');
                row.className = 'table-row';
                row.innerHTML = `
                    <td class="py-4 px-6">
                        <div class="flex items-center space-x-3">
                            <div class="avatar" style="background: ${getEmployeeColor(emp.id)}">
                                ${emp.firstName[0]}${emp.lastName[0]}
                            </div>
                            <div>
                                <p class="font-medium text-gray-900">${emp.firstName} ${emp.lastName}</p>
                                <p class="text-xs text-gray-500">${emp.position || 'No position set'}</p>
                            </div>
                        </div>
                    </td>
                    <td class="py-4 px-6">
                        <span class="badge badge-primary">${emp.department}</span>
                    </td>
                    <td class="py-4 px-6">${emp.email || 'No email'}</td>
                    <td class="py-4 px-6">
                        <div class="flex items-center">
                            <span class="text-xl font-bold text-gray-900 mr-2">${hoursThisWeek.toFixed(1)}</span>
                            <span class="text-sm text-gray-500">hours</span>
                        </div>
                    </td>
                    <td class="py-4 px-6">
                        <span class="badge ${isEmployeeActive(emp.id) ? 'badge-success' : 'badge-warning'}">
                            ${isEmployeeActive(emp.id) ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td class="py-4 px-6">
                        <div class="flex space-x-2">
                            <button onclick="exportEmployeeData('${emp.id}')" class="text-green-600 hover:text-green-800 p-2 rounded-lg hover:bg-green-50" title="Export Data">
                                <i class="fas fa-download"></i>
                            </button>
                            <button onclick="deleteEmployee('${emp.id}')" class="text-red-600 hover:text-red-800 p-2 rounded-lg hover:bg-red-50" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                table.appendChild(row);
            });
            
            document.getElementById('totalTeamMembers').textContent = employeeList.length;
            document.getElementById('employeeCount').textContent = `${employeeList.length} employees`;
        }

        function showAddEmployeeModal() {
            showModal('addEmployeeModal');
        }

        function saveEmployee() {
            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const email = document.getElementById('employeeEmail').value.trim().toLowerCase();
            const password = document.getElementById('employeePassword').value;
            const department = document.getElementById('employeeDept').value;
            const position = document.getElementById('employeePosition').value.trim();
            
            if (!firstName || !lastName || !email || !password) {
                showToast('Please fill all required fields', 'error');
                return;
            }
            
            if (employees.some(e => e.email.toLowerCase() === email)) {
                showToast('Email already exists', 'error');
                return;
            }
            
            const newEmployee = {
                id: 'emp_' + Date.now(),
                firstName: firstName,
                lastName: lastName,
                email: email,
                password: password,
                role: 'employee',
                department: department,
                position: position,
                employeeId: 'EMP' + (employees.filter(e => e.role === 'employee').length + 1).toString().padStart(3, '0'),
                createdAt: new Date().toISOString()
            };
            
            employees.push(newEmployee);
            localStorage.setItem('ce_users', JSON.stringify(employees));
            
            document.getElementById('firstName').value = '';
            document.getElementById('lastName').value = '';
            document.getElementById('employeeEmail').value = '';
            document.getElementById('employeePosition').value = '';
            
            closeModal('addEmployeeModal');
            loadEmployeesTable();
            loadEmployeeFilter();
            updateDashboardStats();
            updateCounts();
            showToast('Employee added successfully', 'success');
        }

        function deleteEmployee(id) {
            if (!confirm('Are you sure you want to delete this employee? All their time records will also be deleted.')) {
                return;
            }
            
            employees = employees.filter(emp => emp.id !== id);
            timeRecords = timeRecords.filter(r => r.userId !== id);
            
            localStorage.setItem('ce_users', JSON.stringify(employees));
            localStorage.setItem('ce_time_records', JSON.stringify(timeRecords));
            
            loadEmployeesTable();
            loadEmployeeFilter();
            loadAllRecords();
            updateDashboardStats();
            updateCounts();
            showToast('Employee deleted', 'info');
        }

        function filterEmployees() {
            const searchTerm = document.getElementById('employeeSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#employeesTable tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function resetEmployeeSearch() {
            document.getElementById('employeeSearch').value = '';
            const rows = document.querySelectorAll('#employeesTable tr');
            rows.forEach(row => row.style.display = '');
        }

        // ==================== RECORDS MANAGEMENT ====================
        function loadAllRecords() {
            const table = document.getElementById('allRecordsTable');
            const filtered = timeRecords.filter(r => !r.isRunning)
                .sort((a, b) => new Date(b.startTime) - new Date(a.startTime))
                .slice(0, 100);
            
            table.innerHTML = '';
            
            if (filtered.length === 0) {
                table.innerHTML = `
                    <tr>
                        <td colspan="7" class="py-8 text-center text-gray-500">
                            <div class="flex flex-col items-center">
                                <i class="fas fa-history text-4xl mb-3 text-gray-300"></i>
                                <p class="font-medium text-gray-700">No time records found</p>
                                <p class="text-sm text-gray-500 mt-1">Employees need to track time to see records here</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            filtered.forEach(record => {
                const row = document.createElement('tr');
                row.className = 'table-row';
                row.innerHTML = `
                    <td class="py-4 px-6">${record.date}</td>
                    <td class="py-4 px-6">
                        <div class="flex items-center space-x-2">
                            <div class="avatar" style="background: ${getEmployeeColor(record.userId)}">
                                ${record.userName ? record.userName.split(' ').map(n => n[0]).join('') : '??'}
                            </div>
                            <span class="font-medium">${record.userName}</span>
                        </div>
                    </td>
                    <td class="py-4 px-6">
                        <span class="badge badge-primary">${record.project}</span>
                    </td>
                    <td class="py-4 px-6">${record.task}</td>
                    <td class="py-4 px-6">${new Date(record.startTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</td>
                    <td class="py-4 px-6">${new Date(record.endTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</td>
                    <td class="py-4 px-6 font-medium">${record.duration}</td>
                `;
                table.appendChild(row);
            });
            
            document.getElementById('recordsCount').textContent = `${timeRecords.filter(r => !r.isRunning).length} total records`;
        }

        function filterRecords() {
            const dateRange = document.getElementById('dateRangeFilter').value;
            const employeeId = document.getElementById('employeeFilter').value;
            const project = document.getElementById('projectFilter').value;
            
            let filtered = timeRecords.filter(r => !r.isRunning);
            
            const today = new Date().toISOString().split('T')[0];
            const startOfWeek = new Date();
            startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay() + 1);
            const startOfMonth = new Date();
            startOfMonth.setDate(1);
            
            if (dateRange === 'today') {
                filtered = filtered.filter(r => r.date === today);
            } else if (dateRange === 'week') {
                filtered = filtered.filter(r => new Date(r.date) >= startOfWeek);
            } else if (dateRange === 'month') {
                filtered = filtered.filter(r => new Date(r.date) >= startOfMonth);
            }
            
            if (employeeId !== 'all') {
                filtered = filtered.filter(r => r.userId === employeeId);
            }
            
            if (project !== 'all') {
                filtered = filtered.filter(r => r.project === project);
            }
            
            filtered.sort((a, b) => new Date(b.startTime) - new Date(a.startTime));
            
            const table = document.getElementById('allRecordsTable');
            table.innerHTML = '';
            
            filtered.forEach(record => {
                const row = document.createElement('tr');
                row.className = 'table-row';
                row.innerHTML = `
                    <td class="py-4 px-6">${record.date}</td>
                    <td class="py-4 px-6">
                        <div class="flex items-center space-x-2">
                            <div class="avatar" style="background: ${getEmployeeColor(record.userId)}">
                                ${record.userName.split(' ').map(n => n[0]).join('')}
                            </div>
                            <span class="font-medium">${record.userName}</span>
                        </div>
                    </td>
                    <td class="py-4 px-6">
                        <span class="badge badge-primary">${record.project}</span>
                    </td>
                    <td class="py-4 px-6">${record.task}</td>
                    <td class="py-4 px-6">${new Date(record.startTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</td>
                    <td class="py-4 px-6">${new Date(record.endTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</td>
                    <td class="py-4 px-6 font-medium">${record.duration}</td>
                `;
                table.appendChild(row);
            });
            
            document.getElementById('recordsCount').textContent = `${filtered.length} filtered records`;
        }

        function resetFilters() {
            document.getElementById('dateRangeFilter').value = 'today';
            document.getElementById('employeeFilter').value = 'all';
            document.getElementById('projectFilter').value = 'all';
            loadAllRecords();
        }

        function loadEmployeeFilter() {
            const filter = document.getElementById('employeeFilter');
            const employeeList = employees.filter(e => e.role === 'employee');
            
            filter.innerHTML = '<option value="all">All Employees</option>';
            employeeList.forEach(emp => {
                const option = document.createElement('option');
                option.value = emp.id;
                option.textContent = `${emp.firstName} ${emp.lastName}`;
                filter.appendChild(option);
            });
        }

        function loadProjectFilter() {
            const filter = document.getElementById('projectFilter');
            const projects = [...new Set(timeRecords.map(r => r.project))].sort();
            
            filter.innerHTML = '<option value="all">All Projects</option>';
            projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project;
                option.textContent = project;
                filter.appendChild(option);
            });
        }

        // ==================== DASHBOARD FUNCTIONS ====================
        function updateDashboardStats() {
            const today = new Date().toISOString().split('T')[0];
            const todayRecords = timeRecords.filter(r => r.date === today && !r.isRunning);
            const totalSecondsToday = todayRecords.reduce((sum, r) => sum + (r.durationSeconds || 0), 0);
            const totalHoursToday = (totalSecondsToday / 3600).toFixed(1);
            
            const startOfWeek = new Date();
            startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay() + 1);
            const weekRecords = timeRecords.filter(r => new Date(r.date) >= startOfWeek && !r.isRunning);
            const weeklySeconds = weekRecords.reduce((sum, r) => sum + (r.durationSeconds || 0), 0);
            const weeklyTotal = (weeklySeconds / 3600).toFixed(1);
            
            const activeTimers = timeRecords.filter(r => r.isRunning).length;
            
            document.getElementById('totalHoursToday').textContent = totalHoursToday;
            document.getElementById('weeklyTotal').textContent = weeklyTotal;
            document.getElementById('activeTimersNow').textContent = activeTimers;
            document.getElementById('daysThisWeek').textContent = new Set(weekRecords.map(r => r.date)).size;
            
            const activeToday = new Set(todayRecords.map(r => r.userId)).size;
            document.getElementById('activeToday').textContent = activeToday;
            
            const uniqueDays = new Set(weekRecords.map(r => r.date)).size;
            const avgHoursPerDay = uniqueDays > 0 ? (weeklySeconds / 3600 / uniqueDays).toFixed(1) : '0.0';
            document.getElementById('avgHoursPerDay').textContent = avgHoursPerDay;
            
            updateDashboardActivity();
            updateCharts();
        }

        function updateDashboardActivity() {
            const container = document.getElementById('dashboardActivity');
            const today = new Date().toISOString().split('T')[0];
            const todayRecords = timeRecords.filter(r => r.date === today)
                .sort((a, b) => new Date(b.startTime) - new Date(a.startTime))
                .slice(0, 5);
            
            container.innerHTML = '';
            
            if (todayRecords.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-400">
                        <i class="fas fa-clock text-4xl mb-3"></i>
                        <p>No activity recorded today</p>
                    </div>
                `;
                return;
            }
            
            todayRecords.forEach(record => {
                const activity = document.createElement('div');
                activity.className = 'flex items-center p-4 hover:bg-gray-50 rounded-xl transition-colors';
                
                const icon = record.isRunning ? 'play-circle' : 'stop-circle';
                const iconColor = record.isRunning ? 'text-green-500' : 'text-blue-500';
                
                activity.innerHTML = `
                    <div class="flex-shrink-0">
                        <div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-${icon} ${iconColor}"></i>
                        </div>
                    </div>
                    <div class="ml-4 flex-1">
                        <div class="flex justify-between">
                            <p class="font-medium text-gray-900">${record.userName}</p>
                            <span class="text-sm font-medium text-gray-900">${record.duration || 'In progress'}</span>
                        </div>
                        <div class="flex items-center mt-1">
                            <span class="badge badge-primary mr-3">${record.project}</span>
                            <span class="text-xs text-gray-500">${record.task}</span>
                        </div>
                    </div>
                `;
                container.appendChild(activity);
            });
        }

        function updateDepartmentOverview() {
            const container = document.getElementById('departmentOverview');
            const deptStats = {};
            
            employees.forEach(emp => {
                if (emp.role === 'employee') {
                    if (!deptStats[emp.department]) {
                        deptStats[emp.department] = {
                            count: 0,
                            hours: 0,
                            employees: []
                        };
                    }
                    deptStats[emp.department].count++;
                    deptStats[emp.department].employees.push(emp);
                }
            });
            
            const startOfWeek = new Date();
            startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay() + 1);
            
            timeRecords.filter(r => {
                const recordDate = new Date(r.date);
                return recordDate >= startOfWeek && !r.isRunning;
            }).forEach(r => {
                const employee = employees.find(e => e.id === r.userId);
                if (employee && deptStats[employee.department]) {
                    deptStats[employee.department].hours += (r.durationSeconds || 0) / 3600;
                }
            });
            
            let html = '';
            if (Object.keys(deptStats).length === 0) {
                html = '<div class="text-center py-4 text-gray-500"><p>No department data available</p></div>';
            } else {
                Object.entries(deptStats).forEach(([dept, stats]) => {
                    html += `
                        <div class="mb-6 last:mb-0 p-4 bg-gray-50 rounded-xl">
                            <div class="flex justify-between items-center mb-3">
                                <span class="font-medium text-gray-900">${dept}</span>
                                <span class="text-sm text-gray-500">${stats.count} employees</span>
                            </div>
                            <div class="text-sm text-gray-600 mb-3">
                                <i class="fas fa-clock mr-1"></i> ${stats.hours.toFixed(1)} hours this week
                            </div>
                            <div class="text-xs text-gray-500">
                                ${stats.employees.map(e => e.firstName).join(', ')}
                            </div>
                        </div>
                    `;
                });
            }
            
            container.innerHTML = html;
        }

        // ==================== CHART FUNCTIONS ====================
        function initializeCharts() {
            // Daily Trend Chart
            const dailyCtx = document.getElementById('dailyTrendChart').getContext('2d');
            dailyTrendChart = new Chart(dailyCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Hours',
                        data: [],
                        backgroundColor: 'rgba(30, 64, 175, 0.1)',
                        borderColor: 'rgba(30, 64, 175, 1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: 'rgba(30, 64, 175, 1)',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { drawBorder: false },
                            ticks: {
                                callback: function(value) {
                                    return value + 'h';
                                }
                            }
                        },
                        x: {
                            grid: { display: false }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.y + ' hours';
                                }
                            }
                        }
                    }
                }
            });
            
            // Department Chart
            const deptCtx = document.getElementById('departmentChart').getContext('2d');
            departmentChart = new Chart(deptCtx, {
                type: 'pie',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            'rgba(30, 64, 175, 0.8)',
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(139, 92, 246, 0.8)',
                            'rgba(245, 158, 11, 0.8)',
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(99, 102, 241, 0.8)'
                        ],
                        borderWidth: 0,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        }
                    }
                }
            });
            
            // Productivity Chart
            const prodCtx = document.getElementById('productivityChart').getContext('2d');
            productivityChart = new Chart(prodCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Productivity %',
                        data: [],
                        backgroundColor: 'rgba(16, 185, 129, 0.2)',
                        borderColor: 'rgba(16, 185, 129, 1)',
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            grid: { drawBorder: false },
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        },
                        x: {
                            grid: { display: false }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
            
            // Project Distribution Chart
            const projectCtx = document.getElementById('projectDistributionChart').getContext('2d');
            projectDistributionChart = new Chart(projectCtx, {
                type: 'polarArea',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            'rgba(30, 64, 175, 0.8)',
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(139, 92, 246, 0.8)',
                            'rgba(245, 158, 11, 0.8)',
                            'rgba(239, 68, 68, 0.8)'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });
            
            updateCharts();
        }

        function updateCharts() {
            updateDailyTrendChart();
            updateDepartmentChart();
            updateProductivityChart();
            updateProjectDistributionChart();
        }

        function updateDailyTrendChart() {
            if (!dailyTrendChart) return;
            
            const labels = [];
            const data = [];
            
            // Get last 7 days
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                
                labels.push(dayName);
                
                const dayRecords = timeRecords.filter(r => r.date === dateStr && !r.isRunning);
                const dayHours = dayRecords.reduce((sum, r) => sum + (r.durationSeconds || 0), 0) / 3600;
                data.push(dayHours);
            }
            
            dailyTrendChart.data.labels = labels;
            dailyTrendChart.data.datasets[0].data = data;
            dailyTrendChart.update();
        }

        function updateDepartmentChart() {
            if (!departmentChart) return;
            
            const deptHours = {};
            const startOfWeek = new Date();
            startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay() + 1);
            
            timeRecords.filter(r => new Date(r.date) >= startOfWeek && !r.isRunning)
                .forEach(r => {
                    const employee = employees.find(e => e.id === r.userId);
                    if (employee && employee.department) {
                        if (!deptHours[employee.department]) {
                            deptHours[employee.department] = 0;
                        }
                        deptHours[employee.department] += (r.durationSeconds || 0) / 3600;
                    }
                });
            
            departmentChart.data.labels = Object.keys(deptHours);
            departmentChart.data.datasets[0].data = Object.values(deptHours);
            departmentChart.update();
        }

        function updateProductivityChart() {
            if (!productivityChart) return;
            
            const labels = [];
            const data = [];
            
            // Get productivity for last 5 employees
            const employeeList = employees.filter(e => e.role === 'employee').slice(0, 5);
            
            employeeList.forEach(emp => {
                const startOfWeek = new Date();
                startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay() + 1);
                
                const weekRecords = timeRecords.filter(r => 
                    r.userId === emp.id && 
                    new Date(r.date) >= startOfWeek && 
                    !r.isRunning
                );
                
                const weekHours = weekRecords.reduce((sum, r) => sum + (r.durationSeconds || 0), 0) / 3600;
                const productivity = Math.min((weekHours / 40) * 100, 100);
                
                labels.push(emp.firstName);
                data.push(productivity);
            });
            
            productivityChart.data.labels = labels;
            productivityChart.data.datasets[0].data = data;
            productivityChart.update();
        }

        function updateProjectDistributionChart() {
            if (!projectDistributionChart) return;
            
            const projectHours = {};
            const startOfWeek = new Date();
            startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay() + 1);
            
            timeRecords.filter(r => new Date(r.date) >= startOfWeek && !r.isRunning)
                .forEach(r => {
                    if (!projectHours[r.project]) {
                        projectHours[r.project] = 0;
                    }
                    projectHours[r.project] += (r.durationSeconds || 0) / 3600;
                });
            
            // Get top 5 projects
            const sortedProjects = Object.entries(projectHours)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            projectDistributionChart.data.labels = sortedProjects.map(p => p[0]);
            projectDistributionChart.data.datasets[0].data = sortedProjects.map(p => p[1]);
            projectDistributionChart.update();
        }

        function updateAnalytics() {
            updatePerformanceSummary();
        }

        function updatePerformanceSummary() {
            const container = document.getElementById('performanceSummary');
            
            const startOfWeek = new Date();
            startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay() + 1);
            
            // Calculate team stats
            const weekRecords = timeRecords.filter(r => new Date(r.date) >= startOfWeek && !r.isRunning);
            const totalHours = weekRecords.reduce((sum, r) => sum + (r.durationSeconds || 0), 0) / 3600;
            const uniqueEmployees = new Set(weekRecords.map(r => r.userId)).size;
            const avgHoursPerEmployee = uniqueEmployees > 0 ? totalHours / uniqueEmployees : 0;
            
            // Find top performer
            const employeeHours = {};
            weekRecords.forEach(r => {
                if (!employeeHours[r.userId]) {
                    employeeHours[r.userId] = 0;
                }
                employeeHours[r.userId] += (r.durationSeconds || 0) / 3600;
            });
            
            let topPerformer = null;
            let maxHours = 0;
            Object.entries(employeeHours).forEach(([id, hours]) => {
                if (hours > maxHours) {
                    maxHours = hours;
                    const emp = employees.find(e => e.id === id);
                    if (emp) topPerformer = emp;
                }
            });
            
            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-blue-50 p-6 rounded-xl">
                        <div class="flex items-center mb-3">
                            <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                                <i class="fas fa-clock text-blue-600"></i>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-blue-900">Total Team Hours</p>
                                <p class="text-2xl font-bold text-gray-900">${totalHours.toFixed(1)}</p>
                            </div>
                        </div>
                        <p class="text-sm text-blue-700">This week</p>
                    </div>
                    
                    <div class="bg-green-50 p-6 rounded-xl">
                        <div class="flex items-center mb-3">
                            <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center mr-3">
                                <i class="fas fa-users text-green-600"></i>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-green-900">Avg. Hours/Employee</p>
                                <p class="text-2xl font-bold text-gray-900">${avgHoursPerEmployee.toFixed(1)}</p>
                            </div>
                        </div>
                        <p class="text-sm text-green-700">Weekly average</p>
                    </div>
                    
                    <div class="bg-purple-50 p-6 rounded-xl">
                        <div class="flex items-center mb-3">
                            <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center mr-3">
                                <i class="fas fa-trophy text-purple-600"></i>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-purple-900">Top Performer</p>
                                <p class="text-xl font-bold text-gray-900">${topPerformer ? topPerformer.firstName + ' ' + topPerformer.lastName : 'None'}</p>
                            </div>
                        </div>
                        <p class="text-sm text-purple-700">${maxHours.toFixed(1)} hours this week</p>
                    </div>
                </div>
            `;
        }

        // ==================== EXPORT FUNCTIONS ====================
        function exportAllData() {
            const employeeRecords = timeRecords.filter(r => !r.isRunning);
            
            if (employeeRecords.length === 0) {
                showToast('No data to export', 'info');
                return;
            }
            
            let csv = 'Date,Employee,Email,Department,Project,Task,Start Time,End Time,Duration (hours),Duration\n';
            
            employeeRecords.forEach(record => {
                const employee = employees.find(e => e.id === record.userId);
                const department = employee ? employee.department : 'Unknown';
                const hours = (record.durationSeconds || 0) / 3600;
                csv += `"${record.date}","${record.userName}","${record.userEmail || ''}","${department}","${record.project}","${record.task}","${record.startTime}","${record.endTime}",${hours.toFixed(2)},"${record.duration}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `codeex-all-data-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            showToast('All data exported to CSV', 'success');
        }

        function exportEmployeeData(employeeId) {
            const employee = employees.find(e => e.id === employeeId);
            const employeeRecords = timeRecords.filter(r => r.userId === employeeId && !r.isRunning);
            
            if (employeeRecords.length === 0) {
                showToast('No data found for this employee', 'info');
                return;
            }
            
            let csv = `Employee Time Report: ${employee.firstName} ${employee.lastName}\n`;
            csv += `Department: ${employee.department}\n`;
            csv += `Position: ${employee.position || 'Not specified'}\n`;
            csv += `Generated: ${new Date().toLocaleDateString()}\n\n`;
            csv += 'Date,Project,Task,Start Time,End Time,Duration (hours),Duration\n';
            
            employeeRecords.forEach(record => {
                const hours = (record.durationSeconds || 0) / 3600;
                csv += `"${record.date}","${record.project}","${record.task}","${record.startTime}","${record.endTime}",${hours.toFixed(2)},"${record.duration}"\n`;
            });
            
            const totalHours = employeeRecords.reduce((sum, r) => sum + (r.durationSeconds || 0), 0) / 3600;
            const avgSession = employeeRecords.length > 0 ? totalHours / employeeRecords.length : 0;
            const daysActive = new Set(employeeRecords.map(r => r.date)).size;
            
            csv += `\nSummary:\n`;
            csv += `Total Hours: ${totalHours.toFixed(2)}\n`;
            csv += `Total Sessions: ${employeeRecords.length}\n`;
            csv += `Days Active: ${daysActive}\n`;
            csv += `Average Session: ${avgSession.toFixed(2)} hours\n`;
            csv += `Average Daily: ${daysActive > 0 ? (totalHours / daysActive).toFixed(2) : 0} hours\n`;
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${employee.firstName}-${employee.lastName}-time-report-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            showToast('Employee data exported', 'success');
        }

        // ==================== UTILITY FUNCTIONS ====================
        function calculateEmployeeHoursThisWeek(employeeId) {
            const startOfWeek = new Date();
            startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay() + 1);
            
            return timeRecords
                .filter(r => r.userId === employeeId && new Date(r.date) >= startOfWeek && !r.isRunning)
                .reduce((sum, r) => sum + (r.durationSeconds || 0), 0) / 3600;
        }

        function isEmployeeActive(employeeId) {
            return timeRecords.some(r => r.userId === employeeId && r.isRunning);
        }

        function getEmployeeColor(employeeId) {
            const colors = [
                '#1e40af', '#047857', '#7c3aed', '#f59e0b', 
                '#ef4444', '#8b5cf6', '#0ea5e9'
            ];
            const index = employees.findIndex(e => e.id === employeeId);
            return colors[Math.abs(index) % colors.length] || '#1e40af';
        }

        function formatDuration(totalSeconds) {
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            
            if (hours > 0) {
                return `${hours}h ${minutes}m`;
            } else if (minutes > 0) {
                return `${minutes}m ${seconds}s`;
            } else {
                return `${seconds}s`;
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            
            let icon = 'fa-info-circle';
            let bgColor = 'bg-blue-600';
            
            if (type === 'success') {
                icon = 'fa-check-circle';
                bgColor = 'bg-green-600';
            } else if (type === 'error') {
                icon = 'fa-exclamation-circle';
                bgColor = 'bg-red-600';
            } else if (type === 'warning') {
                icon = 'fa-exclamation-triangle';
                bgColor = 'bg-yellow-600';
            }
            
            toast.className = `toast ${bgColor}`;
            toast.innerHTML = `
                <div class="flex items-center space-x-3">
                    <i class="fas ${icon}"></i>
                    <span>${message}</span>
                </div>
            `;
            
            toast.classList.remove('hidden');
            
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                }
            });
        });

        // Mobile menu functions
        function toggleMobileMenu() {
            const sidebar = document.querySelector('.sidebar');
            const toggleBtn = document.querySelector('.mobile-menu-toggle i');
            
            sidebar.classList.toggle('active');
            
            if (sidebar.classList.contains('active')) {
                toggleBtn.classList.remove('fa-bars');
                toggleBtn.classList.add('fa-times');
                sidebar.classList.add('expanded');
            } else {
                toggleBtn.classList.remove('fa-times');
                toggleBtn.classList.add('fa-bars');
                sidebar.classList.remove('expanded');
            }
        }

        document.addEventListener('click', function(e) {
            const sidebar = document.querySelector('.sidebar');
            const mobileToggle = document.querySelector('.mobile-menu-toggle');
            
            if (window.innerWidth <= 1200 && 
                sidebar && sidebar.classList.contains('active') && 
                !sidebar.contains(e.target) && 
                !mobileToggle.contains(e.target)) {
                sidebar.classList.remove('active');
                sidebar.classList.remove('expanded');
                mobileToggle.querySelector('i').classList.remove('fa-times');
                mobileToggle.querySelector('i').classList.add('fa-bars');
            }
        });

        document.querySelectorAll('.sidebar-item').forEach(item => {
            item.addEventListener('click', function() {
                if (window.innerWidth <= 1200) {
                    const sidebar = document.querySelector('.sidebar');
                    const mobileToggle = document.querySelector('.mobile-menu-toggle');
                    
                    sidebar.classList.remove('active');
                    sidebar.classList.remove('expanded');
                    if (mobileToggle) {
                        mobileToggle.querySelector('i').classList.remove('fa-times');
                        mobileToggle.querySelector('i').classList.add('fa-bars');
                    }
                }
            });
        });

        // Handle window resize
        let resizeTimer;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(function() {
                if (window.innerWidth > 1200) {
                    const sidebar = document.querySelector('.sidebar');
                    const mobileToggle = document.querySelector('.mobile-menu-toggle');
                    
                    if (sidebar) {
                        sidebar.classList.remove('active');
                        sidebar.classList.add('expanded');
                    }
                    if (mobileToggle) {
                        mobileToggle.querySelector('i').classList.remove('fa-times');
                        mobileToggle.querySelector('i').classList.add('fa-bars');
                    }
                } else {
                    // On mobile, ensure sidebar is collapsed by default
                    const sidebar = document.querySelector('.sidebar');
                    if (sidebar && !sidebar.classList.contains('active')) {
                        sidebar.classList.remove('expanded');
                    }
                }
                
                // Update charts on resize
                if (dailyTrendChart) dailyTrendChart.resize();
                if (departmentChart) departmentChart.resize();
                if (productivityChart) productivityChart.resize();
                if (projectDistributionChart) projectDistributionChart.resize();
                
                // Ensure dashboard is visible
                handleResponsiveLayout();
            }, 250);
        });

        // Prevent body scroll when modal is open on mobile
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('touchmove', function(e) {
                e.preventDefault();
            }, { passive: false });
        });

        console.log('Admin Portal loaded successfully with fixed responsive design');
    </script>
</body>
</html>
